<!doctype html>
<html>
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <meta name="description" content="keep coding, keep foolish"/>
        <meta name="keywords" content="ä»£ç ,æ•°å­¦,æ•°æ®æŒ–æ˜,æœºå™¨å­¦ä¹ ,ç®—æ³•,ç¼–è¯‘å™¨,åˆ†å¸ƒå¼,PHP,Nginx"/>
        <meta name="author" content="å¼ æ´‹"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
        <title>CodingLabs - å¦‚ä½•ä½¿ç”¨PHPç¼–å†™daemon process
</title>
        <link rel="stylesheet" href="/assets/vendor/normalize.css"/>
        <link rel="stylesheet" href="/assets/vendor/google-code-prettify/prettify-solarized-dark.css"/>
        <link rel="stylesheet" href="/assets/themes/default/main.css"/>
        <link rel="shortcut icon" href="/fav.ico"/>
        <script type="text/javascript" src="/assets/vendor/google-code-prettify/prettify.js"></script>
        <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F75dfda8ff8a93fa0b94adeb17da37a2f' type='text/javascript'%3E%3C/script%3E"));
</script>

    </head>
    <body onload="prettyPrint()">
    <div id="header">
        <div id="header-inner">
            <div id="title"><a href="/">CodingLabs</a></div>
            <div id="subtitle">keep coding, keep foolish</div>
        </div>
    </div>

<div id="main">
    <div id="main-inner">
        <div id="topnav">
            <ul>
                <li><a href="/">é¦–é¡µ</a></li>
                <li class="sep"> | </li>
                <li><a href="/tag.html">æ ‡ç­¾</a></li>
                
<li class="sep"> | </li>
<li><a href="/pages/about-me.html" target="_self">å…³äºæˆ‘</a></li>

<li class="sep"> | </li>
<li><a href="/rss.xml" target="_self">+è®¢é˜…</a></li>

<li class="sep"> | </li>
<li><a href="https://github.com/ericzhang-cn/ailingbot" target="_blank">ğŸ¤–AilingBot - IMæœºå™¨äººæ¥å…¥AIèƒ½åŠ›çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆ</a></li>


            </ul>
            <div style="clear:both;"></div>
        </div>
        <div id="article-title">
            <a href="/articles/write-daemon-with-php.html">å¦‚ä½•ä½¿ç”¨PHPç¼–å†™daemon process</a>
        </div>
        <div id="article-meta">
            ä½œè€… å¼ æ´‹ | å‘å¸ƒäº 2011-10-24
        </div>
        <div id="article-tags">
        
        <a class="tag" href="/tag.html#PHP">PHP</a>
        
        <a class="tag" href="/tag.html#Deamon">Deamon</a>
        
        </div>
        <div id="article-content">
            <p>ä»Šå¤©ä¸‹åˆåœ¨<a href="http://segmentfault.com">segmentfault.com</a>çœ‹åˆ°ä¸€ä¸ª<a href="http://segmentfault.com/question/585/php%E6%80%8E%E4%B9%88%E5%81%9A%E6%9C%8D%E5%8A%A1%E5%8C%96" target="_blank">æé—®</a>ï¼Œæé—®æ ‡é¢˜æ˜¯â€œPHPæ€ä¹ˆåšæœåŠ¡åŒ–â€ï¼Œå…¶ä¸­é—®é“phpæ˜¯ä¸æ˜¯åªèƒ½ä»¥webæ–¹å¼è°ƒç”¨ã€‚å…¶å®å¾ˆå¤šäººå¯¹PHPçš„ä½¿ç”¨åœºæ™¯éƒ½æœ‰è¯¯è§£ï¼Œè®¤ä¸ºphpåªèƒ½ç”¨äºç¼–å†™webè„šæœ¬ï¼Œå®é™…ä¸Šï¼Œä»PHP4å¼€å§‹ï¼Œphpçš„ä½¿ç”¨åœºæ™¯æ—©å·²ä¸é™äºå¤„ç†webè¯·æ±‚ã€‚</p>
<p>ä»phpçš„æ¶æ„ä½“ç³»æ¥è¯´ï¼Œphpåˆ†ä¸ºä¸‰ä¸ªå±‚æ¬¡ï¼šsapiã€php coreå’Œzend engineã€‚php coreæœ¬èº«å’Œwebæ²¡æœ‰ä»»ä½•è€¦åˆï¼Œphpé€šè¿‡sapiä¸å…¶å®ƒåº”ç”¨ç¨‹åºé€šä¿¡ï¼Œä¾‹å¦‚mod_phpå°±æ˜¯ä¸ºapacheç¼–å†™çš„sapiå®ç°ï¼ŒåŒæ ·ï¼Œfpmæ˜¯ä¸€ä¸ªåŸºäºfastcgiåè®®çš„sapiå®ç°ï¼Œè¿™äº›sapiéƒ½æ˜¯ä¸web serveré…åˆç”¨äºå¤„ç†webè¯·æ±‚çš„ã€‚ä½†æ˜¯ä¹Ÿæœ‰è®¸å¤šsapiä¸webæ— å…³ï¼Œä¾‹å¦‚cli sapiå¯ä»¥ä½¿å¾—åœ¨å‘½ä»¤è¡Œç¯å¢ƒä¸‹ç›´æ¥æ‰§è¡Œphpï¼Œembed sapiå¯ä»¥å°†phpåµŒå…¥å…¶å®ƒè¯­è¨€ï¼ˆå¦‚Luaï¼‰é‚£æ ·ã€‚è¿™é‡Œæˆ‘å¹¶ä¸æ‰“ç®—è¯¦ç»†è®¨è®ºphpçš„æ¶æ„ä½“ç³»å’Œsapiçš„è¯é¢˜ï¼Œåªæ˜¯è¯´æ˜ä»æ¶æ„ä½“ç³»è§’åº¦ç›®å‰çš„phpæ—©å·²è¢«è®¾è®¡ä¸ºæ”¯æŒå„ç§ç¯å¢ƒï¼Œè€Œéä¸ºwebç‹¬æœ‰ã€‚</p>
<p>é™¤äº†æ¶æ„ä½“ç³»çš„æ”¯æŒå¤–ï¼Œphpä¸°å¯Œçš„æ‰©å±•æ¨¡å—ä¹Ÿä¸ºphpåœ¨ä¸åŒç¯å¢ƒå‘æŒ¥ä½œç”¨æä¾›äº†åç›¾ï¼Œä¾‹å¦‚æœ¬æ–‡è¦æåˆ°çš„<a href="http://cn.php.net/manual/en/book.pcntl.php" target="_blank">pcntlæ¨¡å—</a>å’Œ<a href="http://cn.php.net/manual/en/book.posix.php" target="_blank">posixæ¨¡å—</a>é…åˆå¯ä»¥å®ç°åŸºæœ¬çš„è¿›ç¨‹ç®¡ç†ã€ä¿¡å·å¤„ç†ç­‰æ“ä½œç³»ç»Ÿçº§åˆ«çš„åŠŸèƒ½ï¼Œè€Œ<a href="http://cn.php.net/manual/en/book.sockets.php" target="_blank">socketsæ¨¡å—</a>å¯ä»¥ä½¿phpå…·æœ‰socketé€šä¿¡çš„èƒ½åŠ›ã€‚å› æ­¤phpå®Œå…¨å¯ä»¥ç”¨äºç¼–å†™ç±»ä¼¼äºshellæˆ–perlå¸¸åšçš„å·¥å…·æ€§è„šæœ¬ï¼Œç”šè‡³æ˜¯å…·æœ‰serveræ€§è´¨çš„daemon processã€‚</p>
<p>ä¸ºäº†å±•ç¤ºphpå¦‚ä½•ç¼–å†™daemon serverï¼Œæˆ‘ç”¨phpç¼–å†™äº†ä¸€ä¸ªç®€å•çš„http serverï¼Œè¿™ä¸ªserverä»¥daemon processçš„å½¢å¼è¿è¡Œã€‚å½“ç„¶ï¼Œä¸ºäº†æŠŠé‡ç‚¹æ”¾åœ¨å¦‚ä½•ä½¿ç”¨phpç¼–å†™daemonï¼Œæˆ‘æ²¡æœ‰ä¸ºè¿™ä¸ªhttp serverå®ç°å…·ä½“ä¸šåŠ¡é€»è¾‘ï¼Œä½†å®ƒå¯ä»¥ç›‘å¬æŒ‡å®šç«¯å£ï¼Œæ¥å—httpè¯·æ±‚å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ä¸€æ¡å›ºå®šçš„æ–‡æœ¬ï¼Œæ•´ä¸ªè¿‡ç¨‹é€šè¿‡socketå®ç°ï¼Œå…¨éƒ¨ç”±phpç¼–å†™è€Œæˆã€‚</p>
<!--more-->
<h1>ä»£ç å®ä¾‹</h1>
<p>ä¸‹é¢æ˜¯è¿™ä¸ªç¨‹åºçš„å®Œæ•´ä»£ç ï¼š</p>
<pre class="prettyprint linenums">&lt;?php

//Accpet the http client request and generate response content.
//As a demo, this function just send "PHP HTTP Server" to client.
function handle_http_request($address, $port)
{
    $max_backlog = 16;
    $res_content = "HTTP/1.1 200 OK
        Content-Length: 15
        Content-Type: text/plain; charset=UTF-8

        PHP HTTP Server";
    $res_len = strlen($res_content);

    //Create, bind and listen to socket
    if(($socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP)) === FALSE)
    {
        echo "Create socket failed!\n";
        exit;
    }   

    if((socket_bind($socket, $address, $port)) === FALSE)
    {
        echo "Bind socket failed!\n";
        exit;
    }

    if((socket_listen($socket, $max_backlog)) === FALSE)
    {
        echo "Listen to socket failed!\n";
        exit;
    }

    //Loop
    while(TRUE)
    {
        if(($accept_socket = socket_accept($socket)) === FALSE)
        {
            continue;
        }
        else
        {
            socket_write($accept_socket, $res_content, $res_len);   
            socket_close($accept_socket);
        }
    }
}

//Run as daemon process.
function run()
{
    if(($pid1 = pcntl_fork()) === 0)
    //First child process
    {
        posix_setsid(); //Set first child process as the session leader.

        if(($pid2 = pcntl_fork()) === 0)
        //Second child process, which run as daemon.
        {
            //Replaced with your own domain or address.
            handle_http_request('www.codinglabs.org', 9999); 
        }
        else
        {
            //First child process exit;
            exit;
        }
    }
    else
    {
        //Wait for first child process exit;
        pcntl_wait($status);
    }
}

//Entry point.
run();

?&gt;</pre>
<p>è¿™é‡Œæˆ‘å‡è®¾å„ä½å¯¹Unixç¯å¢ƒç¼–ç¨‹éƒ½æ¯”è¾ƒäº†è§£ï¼Œæ‰€ä»¥ä¸åšå¤ªå¤šç»†èŠ‚çš„è§£é‡Šï¼Œåªæ¢³ç†ä¸€ä¸‹ã€‚ç®€å•æ¥çœ‹ï¼Œè¿™ä¸ªç¨‹åºä¸»è¦ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼Œhandle_http_requestå‡½æ•°è´Ÿè´£å¤„ç†httpè¯·æ±‚ï¼Œå…¶ç¼–å†™æ–¹æ³•ä¸ç”¨Cç¼–å†™çš„tcp serverç±»ä¼¼ï¼šåˆ›å»ºsocketã€ç»‘å®šã€ç›‘å¬ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå¾ªç¯å¤„ç†æ¯ä¸ªconnectè¿‡æ¥çš„å®¢æˆ·ç«¯ï¼Œä¸€æ—¦acceptåˆ°ä¸€ä¸ªè¿æ¥ï¼Œåˆ™è¾“å‡ºå›ºå®šçš„æ–‡æœ¬â€œPHP HTTP Serverâ€ï¼ˆå½“ç„¶httpå¤´éœ€è¦é¦–å…ˆæ„å»ºå¥½ï¼‰ï¼Œè¿™é‡Œæ²¡æœ‰è€ƒè™‘å¤šè·¯å¤ç”¨å’Œéé˜»å¡ç­‰æƒ…å†µï¼Œè€Œåªæ˜¯ä¸€ä¸ªç®€å•çš„åŒæ­¥é˜»å¡tcp serverã€‚</p>
<p>runå‡½æ•°è´Ÿè´£å°†æ•´ä¸ªç¨‹åºå˜ä¸ºdaemon processï¼Œæ–¹æ³•å’ŒUnixç¯å¢ƒä¸‹Cçš„æ–¹æ³•å¾ˆç±»ä¼¼ï¼Œé€šè¿‡ä¸¤æ¬¡forkï¼Œç¬¬ä¸€æ¬¡forkåè°ƒç”¨setsidå°†å­è¿›ç¨‹1å˜ä¸ºsession leaderï¼Œè¿™æ ·å°±å¯ä»¥è®©å­è¿›ç¨‹2ä¸å…¶ç¥–å…ˆdetachï¼Œå³ä½¿ç¥–å…ˆè¿›ç¨‹ç»“æŸäº†å®ƒä¹Ÿä¼šç»§ç»­è¿è¡Œï¼ˆæ‰˜å­¤ç»™initè¿›ç¨‹ï¼‰ã€‚ç›¸å…³ç»†èŠ‚æˆ‘ä¸å†èµ˜è¿°ï¼Œå¯¹Unixè¿›ç¨‹ç›¸å…³ä¸ç†Ÿæ‚‰çš„æœ‹å‹å¯ä»¥å‚è€ƒã€Š<a href="http://www.kohala.com/start/apue.html" target="_blank">Advanced Programming in the UNIX Environment</a>ã€‹ä¸€ä¹¦ã€‚</p>
<p>æ³¨æ„ï¼Œåœ¨è¿™é‡Œ<a href="http://cn.php.net/manual/en/function.pcntl-fork.php" target="_blank">pcntl_fork</a>å¯¹åº”Unixä¸­çš„forkï¼Œ<a href="http://cn.php.net/manual/en/function.pcntl-wait.php" target="_blank">pcntl_wait</a>å¯¹åº”waitï¼Œè€Œ<a href="http://cn.php.net/manual/en/function.posix-setsid.php" target="_blank">posix_setsid</a>å¯¹åº”setsidï¼Œæ›´å¤šå‡½æ•°å¯ä»¥å‚è€ƒPHP Manualä¸­çš„pcntlå’Œforkæ¨¡å—ç›¸å…³å†…å®¹ã€‚</p>
<h1>æ£€éªŒ</h1>
<p>ä¸‹é¢åœ¨å‘½ä»¤è¡Œä¸‹å¯åŠ¨è¿™ä¸ªè„šæœ¬ï¼š</p><pre class="prettyprint linenums">php httpserver.php</pre>
<p>ç”¨pså‘½ä»¤å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å·²ç»å¯åŠ¨äº†ä¸€ä¸ªdaemonè¿›ç¨‹ï¼š</p>
<p class="picture"><img alt="" src="/uploads/pictures/write-daemon-with-php/1.png"/></p>
<p>è¿™é‡Œæˆ‘ç»‘å®šçš„æ˜¯æˆ‘åšå®¢çš„åŸŸåwww.codinglabs.orgï¼Œç«¯å£æ˜¯9999ï¼Œå¯ä»¥æŒ‰éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚</p>
<p>ä¸‹é¢æˆ‘å…ˆç”¨curlå‘½ä»¤çœ‹ä¸‹è¿™ä¸ªhttp serveræ˜¯å¦æ­£å¸¸è¿è¡Œï¼š</p>
<p class="picture"><img alt="" src="/uploads/pictures/write-daemon-with-php/2.png"/></p>
<p>çœ‹æ¥æ˜¯æ²¡é—®é¢˜ï¼Œå†åˆ°æµè§ˆå™¨ä¸­çœ‹ä¸€ä¸‹ï¼š</p>
<p class="picture"><img alt="" src="/uploads/pictures/write-daemon-with-php/3.png"/></p>
<h1>ç»“è¯­</h1>
<p>å½“ç„¶ï¼Œè¿™ä¸ªç¨‹åºç®—ä¸ä¸ŠçœŸæ­£çš„http serverï¼Œå³ä½¿ä½œä¸ºä¸€ä¸ªdaemon processï¼Œä¹Ÿæ˜¯ä¸å®Œå–„çš„ï¼Œå¾ˆå¤šå¿…è¦çš„äº‹æƒ…å¦‚ä¿®æ”¹æ‰§è¡Œç›®å½•ï¼ˆphpä¸­å¯ä»¥é€šè¿‡chrootå®ç°ï¼‰ã€ä¿¡å·ç»‘å®šã€æ—¥å¿—åŠŸèƒ½ç­‰ç­‰éƒ½æ²¡æœ‰å»åšï¼Œä¸è¿‡ä½œä¸ºä¸€ä¸ªdemoï¼Œå®ƒå·²ç»è¶³å¤Ÿè¯´æ˜phpä¸åªæ˜¯å¯ä»¥ç¼–å†™åŠ¨æ€ç½‘é¡µå¤„ç†è„šæœ¬ã€‚å¦‚æœæœ‰çš„æœ‹å‹æœ‰å…´è¶£ï¼Œå¯ä»¥ä½¿ç”¨phpå°†æˆ‘ä¸Šé¢è¯´çš„åŠŸèƒ½ä¸ºè¿™ä¸ªçš„http serveråŠ ä¸Šã€‚</p>
<p>è¿˜æœ‰ä¸€ç‚¹è¦è¯´æ˜çš„æ˜¯ï¼Œpcntlå’Œsocketsæ¨¡å—é»˜è®¤æ˜¯ä¸å®‰è£…çš„ï¼Œå¦‚æœåœ¨å®‰è£…phpæ—¶æ²¡æœ‰é€šè¿‡å‚æ•°æŒ‡å®šå®‰è£…ï¼Œåˆ™éœ€è¦å•ç‹¬å®‰è£…è¿™ä¸¤ä¸ªæ‰©å±•æ¨¡å—ã€‚</p>

        </div>
        <!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c74f9b0c9ea5242"></script>
<!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_inline_share_toolbox"></div>

    </div>
</div>
        <div id="footer">
            <div id="footer-inner">
                <p id="copyright">Copyright (c) 2011-2019 CodingLabs æœ¬åšå®¢å†…å®¹é‡‡ç”¨<a href="http://creativecommons.org/licenses/by/3.0/cn/" target="_blank">çŸ¥è¯†å…±äº«ç½²å 3.0 ä¸­å›½å¤§é™†è®¸å¯åè®®</a>è¿›è¡Œè®¸å¯</p>
            </div>
        </div>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                tex2jax: {
                    inlineMath: [['$','$'], ['\\(','\\)']],
                    processEscapes: true
                }
            });
        </script>
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </body>
</html>

